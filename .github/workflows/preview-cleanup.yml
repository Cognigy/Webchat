# Removes the preview deployment from gh-pages when a PR is closed or merged.
#
# Counterpart to preview-deploy.yml â€” keeps the gh-pages branch clean
# by removing subdirectories for PRs that no longer need a preview.

name: PR Preview Cleanup

on:
    pull_request:
        types: [closed]

permissions:
    contents: write
    pull-requests: write

jobs:
    cleanup-preview:
        runs-on: ubuntu-latest

        env:
            PR_NUMBER: ${{ github.event.pull_request.number }}

        steps:
            - name: Checkout gh-pages branch
              uses: actions/checkout@v4
              with:
                  ref: gh-pages
                  fetch-depth: 1
              # If gh-pages doesn't exist yet, there's nothing to clean up
              continue-on-error: true
              id: checkout

            - name: Remove preview directory
              if: steps.checkout.outcome == 'success'
              run: |
                  if [ ! -d "pr/${PR_NUMBER}" ]; then
                    echo "No preview directory found for PR #${PR_NUMBER}, nothing to clean up."
                    exit 0
                  fi

                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  rm -rf "pr/${PR_NUMBER}"
                  git add -A "pr/${PR_NUMBER}"

                  git diff --cached --quiet && {
                    echo "No changes to commit."
                    exit 0
                  }

                  git commit -m "cleanup: remove preview for PR #${PR_NUMBER}"
                  git push origin gh-pages

            - name: Update PR comment
              if: steps.checkout.outcome == 'success'
              uses: actions/github-script@v7
              with:
                  script: |
                      const prNumber = Number(process.env.PR_NUMBER);
                      const repo = context.repo;
                      const marker = '<!-- webchat-preview-bot -->';

                      const { data: comments } = await github.rest.issues.listComments({
                        ...repo,
                        issue_number: prNumber,
                        per_page: 100,
                      });

                      const existing = comments.find(c => c.body && c.body.includes(marker));
                      if (!existing) return;

                      const merged = context.payload.pull_request.merged;
                      const action = merged ? 'merged' : 'closed';

                      const body = [
                        marker,
                        `### :wastebasket: Webchat Preview Removed`,
                        '',
                        `The preview deployment for this PR has been cleaned up (PR ${action}).`,
                      ].join('\n');

                      await github.rest.issues.updateComment({
                        ...repo,
                        comment_id: existing.id,
                        body,
                      });
