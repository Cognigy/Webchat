# Deploys a live preview of the Webchat for every PR to GitHub Pages.
#
# Each PR gets its own subdirectory:  https://<org>.github.io/Webchat/pr/<PR_NUMBER>/
#
# Endpoint configuration priority (highest to lowest):
#   1. Runtime query parameter:        ?endpoint=<url>&options=<json>
#   2. Build-time from PR description: <!-- WEBCHAT_ENDPOINT: https://... -->
#   3. Build-time repo variable:       vars.PREVIEW_ENDPOINT_URL
#   4. Manual entry on the preview page UI
#
# Required setup:
#   - Enable GitHub Pages on the `gh-pages` branch (root /)
#   - (Optional) Set repository variable  PREVIEW_ENDPOINT_URL  with a default endpoint
#   - (Optional) Set repository variable  PREVIEW_WEBCHAT_OPTIONS  with default JSON options

name: PR Preview Deploy

on:
    pull_request:
        types: [opened, synchronize, reopened]

# Only allow one deploy per PR at a time; cancel in-progress runs for the same PR
concurrency:
    group: preview-${{ github.event.pull_request.number }}
    cancel-in-progress: true

permissions:
    contents: write
    deployments: write

jobs:
    deploy-preview:
        runs-on: ubuntu-latest
        if: github.event.pull_request.draft == false && github.event.pull_request.head.repo.full_name == github.repository

        environment:
            name: pr-preview-${{ github.event.pull_request.number }}
            url: ${{ steps.pages-url.outputs.url }}

        env:
            PR_NUMBER: ${{ github.event.pull_request.number }}
            COMMIT_SHA: ${{ github.event.pull_request.head.sha }}

        steps:
            # ── 1. Build ────────────────────────────────────────────────────────
            - name: Checkout PR branch
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 24.x
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build webchat bundle
              run: npm run build:umd

            # ── 2. Resolve endpoint config ─────────────────────────────────────
            - name: Extract endpoint config from PR description
              id: pr-config
              env:
                  PR_BODY: ${{ github.event.pull_request.body }}
              run: |
                  # Extract from:  <!-- WEBCHAT_ENDPOINT: https://... -->
                  ENDPOINT=$(echo "$PR_BODY" | grep -oP '<!--\s*WEBCHAT_ENDPOINT:\s*\K[^\s]+(?=\s*-->)' || true)

                  # Extract from:  <!-- WEBCHAT_OPTIONS: {...} -->
                  OPTIONS=$(echo "$PR_BODY" | grep -oP '<!--\s*WEBCHAT_OPTIONS:\s*\K.+(?=\s*-->)' | head -1 || true)

                  echo "endpoint=${ENDPOINT}" >> "$GITHUB_OUTPUT"

                  # Use heredoc for OPTIONS since JSON may contain newlines and special chars
                  {
                    echo "options<<OPTS_EOF"
                    echo "$OPTIONS"
                    echo "OPTS_EOF"
                  } >> "$GITHUB_OUTPUT"

            - name: Resolve final endpoint URL and options
              id: resolve
              run: |
                  # Priority: PR description > repo variable > empty (user enters at runtime)
                  ENDPOINT="${{ steps.pr-config.outputs.endpoint }}"
                  if [ -z "$ENDPOINT" ]; then
                    ENDPOINT="${{ vars.PREVIEW_ENDPOINT_URL }}"
                  fi

                  OPTIONS="${{ steps.pr-config.outputs.options }}"
                  if [ -z "$OPTIONS" ]; then
                    OPTIONS="${{ vars.PREVIEW_WEBCHAT_OPTIONS }}"
                  fi

                  echo "endpoint=${ENDPOINT}" >> "$GITHUB_OUTPUT"

                  # Use heredoc for OPTIONS since JSON may contain newlines and special chars
                  {
                    echo "options<<OPTS_EOF"
                    echo "$OPTIONS"
                    echo "OPTS_EOF"
                  } >> "$GITHUB_OUTPUT"

            # ── 3. Compute the preview URL ──────────────────────────────────────
            - name: Compute Pages preview URL
              id: pages-url
              env:
                  ENDPOINT_URL: ${{ steps.resolve.outputs.endpoint }}
              run: |
                  REPO="${{ github.repository }}"
                  OWNER="${REPO%%/*}"
                  REPO_NAME="${REPO##*/}"
                  BASE_URL="https://${OWNER}.github.io/${REPO_NAME}/pr/${PR_NUMBER}/"

                  if [ -n "$ENDPOINT_URL" ]; then
                    ENCODED=$(python3 -c "import urllib.parse, os; print(urllib.parse.quote(os.environ['ENDPOINT_URL'], safe=''))")
                    FULL_URL="${BASE_URL}?endpoint=${ENCODED}"
                  else
                    FULL_URL="${BASE_URL}"
                  fi

                  echo "url=${FULL_URL}" >> "$GITHUB_OUTPUT"

            # ── 4. Prepare preview artifacts ────────────────────────────────────
            - name: Prepare preview site
              env:
                  ENDPOINT_URL: ${{ steps.resolve.outputs.endpoint }}
                  WEBCHAT_OPTIONS: ${{ steps.resolve.outputs.options }}
              run: |
                  STAGING="_preview_staging"
                  mkdir -p "${STAGING}"

                  # Copy webchat bundle
                  cp dist/webchat.js "${STAGING}/webchat.js"

                  # Copy and hydrate the preview HTML template
                  cp .github/preview/index.html "${STAGING}/index.html"

                  # Inject build-time config as a safe JSON data block.
                  # Using json.dumps handles all escaping (quotes, backslashes,
                  # </script>, newlines, etc.) — no injection risk.
                  python3 << 'PYEOF'
                  import os, json

                  path = "_preview_staging/index.html"
                  with open(path) as f:
                      content = f.read()

                  config = {
                      "prNumber":  os.environ.get("PR_NUMBER", ""),
                      "commitSha": os.environ.get("COMMIT_SHA", ""),
                      "endpoint":  os.environ.get("ENDPOINT_URL", ""),
                      "options":   os.environ.get("WEBCHAT_OPTIONS", ""),
                  }

                  # json.dumps produces a safe string with all special chars escaped
                  config_json = json.dumps(config, ensure_ascii=True)
                  content = content.replace("%%BUILD_CONFIG_JSON%%", config_json)

                  with open(path, 'w') as f:
                      f.write(content)
                  PYEOF

                  echo "::group::Preview staging contents"
                  ls -la "${STAGING}"
                  echo "::endgroup::"

            # ── 5. Deploy to gh-pages ───────────────────────────────────────────
            - name: Deploy to gh-pages branch
              run: |
                  STAGING="_preview_staging"

                  # Stash the built preview files outside the repo working tree
                  TMPDIR=$(mktemp -d)
                  cp "${STAGING}"/* "${TMPDIR}/"

                  # Configure git identity
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  # Switch to gh-pages (fetch existing or create orphan)
                  git fetch origin gh-pages --depth=1 2>/dev/null && \
                    git checkout gh-pages || {
                      git checkout --orphan gh-pages
                      git rm -rf . 2>/dev/null || true
                      echo "# Webchat PR Previews" > README.md
                      touch .nojekyll
                      git add README.md .nojekyll
                      git commit -m "chore: initialize gh-pages for PR previews"
                    }

                  # Clear old version of this PR and copy fresh build
                  rm -rf "pr/${PR_NUMBER}"
                  mkdir -p "pr/${PR_NUMBER}"
                  cp "${TMPDIR}/webchat.js"  "pr/${PR_NUMBER}/webchat.js"
                  cp "${TMPDIR}/index.html"  "pr/${PR_NUMBER}/index.html"

                  git add "pr/${PR_NUMBER}"
                  git diff --cached --quiet && echo "No changes to deploy" || {
                    git commit -m "deploy: preview for PR #${PR_NUMBER} (${COMMIT_SHA:0:7})"
                    git push origin gh-pages
                  }
